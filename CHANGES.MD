# Изменения в системе - Модуль Collect

## Обзор
Добавлен модуль синхронизации результатов инференса для работы с 8 каналами аудио в новой мультипроцессной архитектуре.

## Критические изменения

### Новая архитектура системы:
```text
[Запись] → [8 входных очередей] → [8 процессов инференса] → [Общая очередь] → [Коллектор] → [Синхр. данные]
```

### Основные компоненты:

1. **`src/collect.py`** - новый модуль синхронизации
   - `ResultCollector` - сбор и синхронизация результатов
   - `InferenceResult` - структура данных для результатов
   - Синхронизация по временным меткам, таймауты 2 секунды

2. **`src/broker.py`** - полностью переработан
   - Мультипроцессная архитектура (8 процессов)
   - Интеграция с коллектором через `setup_collector()`
   - Возвращает `(input_queues, result_queue, processes, collector)`

3. **`src/process_channel.py`** - новый файл
   - Отдельный процесс для каждого канала
   - Thread-local ONNX сессии для оптимизации

4. **`src/inference.py`** - адаптирован
   - `do_inference()` теперь возвращает результат
   - Поддержка многопроцессной работы

### Интеграционные изменения:

- **`src/capture.py`** - работает с новой системой процессов
- **`src/control.py`** - команда `start` использует обновленный брокер
- **`src/logger.py`** - улучшенная обработка ошибок, абсолютные пути
- **`src/config.py`** - добавлен `CollectorConfig`

## Как работает система

1. **Запись** распределяет аудио по 8 очередям циклически
2. **8 процессов** параллельно выполняют инференс
3. **Коллектор** получает результаты и синхронизирует по времени
4. **Полные наборы** (все 8 каналов) логируются в `model.log.jsonl`
5. **Неполные наборы** удаляются через 2 секунды

## Тестирование


# Базовый функциональный тест
```bash
python tests/simple_collector_test.py
```
# Полная проверка с логированием
```bash
python tests/final_test.py
```

# Интеграционный тест (broker + collector)
```bash
python tests/test_broker_integration.py
```

# Верификация логов
```bash
python tests/final_verification.py
```

# Запуск
```bash
whirr start  # Основная команда
```

# Мониторинг
Для проверки работы следите за логами:

```bash
tail -f logs/model.log.jsonl
```
Успешная работа подтверждается записями:

```json
{"level": "INFO", "message": "Complete set - Time: ..., Channels: [0,1,2,3,4,5,6,7]"}
```

